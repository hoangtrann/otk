name: Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  quality:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"

    - name: Set up Python
      run: uv python install 3.11

    - name: Install dependencies
      run: |
        uv sync --dev
        uv pip install ruff black mypy

    - name: Format check with black
      run: |
        uv run black --check --diff otk/
      continue-on-error: true

    - name: Lint with ruff
      run: |
        uv run ruff check otk/
      continue-on-error: true

    - name: Type check with mypy
      run: |
        uv run mypy otk/ --ignore-missing-imports
      continue-on-error: true

    - name: Security check with bandit
      run: |
        uv pip install bandit
        uv run bandit -r otk/ -f json -o bandit-report.json
      continue-on-error: true

    - name: Upload bandit report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: bandit-report
        path: bandit-report.json